class <%= name %>.API

  constructor: (@login, @password) ->

  requestURI: (path, query={}) ->
    # NOTE: Setup your own API endpoint, as below
    <%= name %>.API_ENDPOINT = "http://<%= name_underscore %>.com/api"

    uri = "#{<%= name %>.API_ENDPOINT}#{path}.json?"
    for own key, value of query
      uri += "#{ key }=#{ escape(value) }&"

    uri
  
  request: (path, options, authenticated=true) ->
    options.method  ?= 'GET'
    options.query   ?= {}
    options.success ?= -> Ti.API.info
    options.error   ?= -> Ti.API.error

    xhr = Ti.Network.createHTTPClient()
    xhr.onreadystatechange = (e) ->
      Ti.API.debug("READY STATE: #{@readyState}")
      if @readyState == 4 and @status == 401
        Ti.App.fireEvent 'login:failed', @status

    xhr.onload = (e) ->
      try
        data = JSON.parse(@responseText)
        if data.error?
          options.error(data)
        else
          options.success(data)
      catch exception
        options.error(exception)

    uri = @requestURI(path, options.query)
    xhr.open(options.method, uri)
    xhr.setRequestHeader 'Authorization', 'Basic ' + Ti.Utils.base64encode(@login+':'+@password) if authenticated

    message = "Executing "
    message += if authenticated then "Authenticated " else "Unauthenticated "
    message += "#{options.method} #{uri}"
    Ti.API.debug(message) if options.debug

    if options.body?
      xhr.setRequestHeader('Accept', 'application/json')
      xhr.setRequestHeader('Content-Type', 'application/json')
      data = JSON.stringify(options.body)
      Ti.API.debug(data) if options.debug
      xhr.send(data)
    else
      xhr.send()

  get: (path, options, authenticated=true) ->
    options.method = 'GET'
    @request path, options, authenticated

  post: (path, options, authenticated=true) ->
    options.method = 'POST'
    @request path, options, authenticated

  put: (path, options, authenticated=true) ->
    options.method = 'PUT'
    @request path, options, authenticated

  delete: (path, options, authenticated=true) ->
    options.method = 'DELETE'
    @request path, options, authenticated
